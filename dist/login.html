<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SquareHero Login</title>
    <link rel="stylesheet" href="login.css">
    <link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@400;500;600;700&display=swap"
        rel="stylesheet">
        
    <!-- Load Auth Service -->
    <script src="auth.js"></script>
</head>

<body>
    <div class="sh-login-wrapper">
        <!-- Gradient Circle 1 -->
        <div class="gradient-circle-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 639 701" fill="none">
                <g filter="url(#a)" opacity=".4">
                    <circle cx="288.5" cy="350.5" r="256.5" fill="url(#b)" fill-opacity=".7"></circle>
                </g>
                <defs>
                    <linearGradient id="b" x1="288.5" x2="288.5" y1="94" y2="607" gradientUnits="userSpaceOnUse">
                        <stop stop-color="#00D1FF"></stop>
                        <stop offset=".45" stop-color="#A603F3"></stop>
                        <stop offset=".975" stop-color="#FF00E6"></stop>
                    </linearGradient>
                    <filter id="a" width="701" height="701" x="-62" y="0" color-interpolation-filters="sRGB"
                        filterUnits="userSpaceOnUse">
                        <feFlood flood-opacity="0" result="BackgroundImageFix"></feFlood>
                        <feBlend in="SourceGraphic" in2="BackgroundImageFix" result="shape"></feBlend>
                        <feGaussianBlur result="effect1_foregroundBlur_200_26237" stdDeviation="47"></feGaussianBlur>
                    </filter>
                </defs>
            </svg>
        </div>

        <!-- Gradient Circle 2 -->
        <div class="gradient-circle-2">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 639 701" fill="none">
                <g filter="url(#a)" opacity=".4">
                    <circle cx="288.5" cy="350.5" r="256.5" fill="url(#b)" fill-opacity=".7"></circle>
                </g>
                <defs>
                    <linearGradient id="b" x1="288.5" x2="288.5" y1="94" y2="607" gradientUnits="userSpaceOnUse">
                        <stop stop-color="#00D1FF"></stop>
                        <stop offset=".45" stop-color="#A603F3"></stop>
                        <stop offset=".975" stop-color="#FF00E6"></stop>
                    </linearGradient>
                    <filter id="a" width="701" height="701" x="-62" y="0" color-interpolation-filters="sRGB"
                        filterUnits="userSpaceOnUse">
                        <feFlood flood-opacity="0" result="BackgroundImageFix"></feFlood>
                        <feBlend in="SourceGraphic" in2="BackgroundImageFix" result="shape"></feBlend>
                        <feGaussianBlur result="effect1_foregroundBlur_200_26237" stdDeviation="47"></feGaussianBlur>
                    </filter>
                </defs>
            </svg>
        </div>

        <div class="sh-login-container">
            <div class="sh-login-header">
                <img src="sh-logo.png" alt="SquareHero Logo" width="180">
                <h1>Dashboard Login</h1>
            </div>
            <form class="sh-login-form" id="loginForm">
                <input type="email" class="sh-login-input" name="email" placeholder="Enter email" required>
                <input type="password" class="sh-login-input" name="password" placeholder="Enter password" required>
                <button type="submit" class="sh-login-button">Login to Dashboard</button>
                <a href="#" class="sh-forgot-password" id="forgotPassword">Forgot Password?</a>
            </form>
        </div>
    </div>

    <!-- Alert Container -->
    <div class="alert" id="alert">
        <div class="alert-message">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                <path class="alert-icon-success" d="M8 12l3 3 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"/>
                <path class="alert-icon-error" d="M12 8v5m0 2v.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="display: none;"/>
            </svg>
            <span class="alert-text"></span>
        </div>
        <div class="alert-actions">
            <button type="button" class="alert-close">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";

        // Initialize Firebase with the existing config
        const firebaseConfig = {
            apiKey: "AIzaSyBEmTwE1DWjj4rGEV6UDGIhxVy4oZ5lqNg",
            authDomain: "my-squarehero-hub.firebaseapp.com",
            databaseURL: "https://my-squarehero-hub-default-rtdb.firebaseio.com",
            projectId: "my-squarehero-hub",
            storageBucket: "my-squarehero-hub.firebasestorage.app",
            messagingSenderId: "233555790724",
            appId: "1:233555790724:web:062d5a4b5d38f7445b2bd1",
            measurementId: "G-YEMQV45TPL"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Alert management
        const alertEl = document.getElementById('alert');
        const alertText = alertEl.querySelector('.alert-text');
        const alertIconSuccess = alertEl.querySelector('.alert-icon-success');
        const alertIconError = alertEl.querySelector('.alert-icon-error');
        let alertTimeout;

        function showAlert(message, type = 'error') {
            // Clear any existing timeout
            if (alertTimeout) {
                clearTimeout(alertTimeout);
            }

            // Update alert content
            alertText.textContent = message;
            alertEl.className = `alert visible ${type}`;

            // Show/hide appropriate icon
            alertIconSuccess.style.display = type === 'success' ? 'block' : 'none';
            alertIconError.style.display = type === 'error' ? 'block' : 'none';

            // Auto-hide after 5 seconds
            alertTimeout = setTimeout(() => {
                hideAlert();
            }, 5000);
        }

        function hideAlert() {
            alertEl.classList.remove('visible');
        }

        // Add event listener to close button
        alertEl.querySelector('.alert-close').addEventListener('click', hideAlert);

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;

            try {
                // Sign in with Firebase
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Set the user in SecureFirebaseAuth if available
                if (window.SecureFirebaseAuth) {
                    window.SecureFirebaseAuth.setCurrentUser(user);
                    // Initialize SecureFirebaseAuth
                    await window.SecureFirebaseAuth.initialize();
                }
                
                showAlert('Login successful, redirecting...', 'success');
                
                // Store auth info in session storage to persist across page reloads
                sessionStorage.setItem('squarehero_user_email', email);
                
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1000);
            } catch (error) {
                let errorMessage = 'Login failed. Please check your credentials.';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No account found with this email address.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Incorrect password.';
                }
                showAlert(errorMessage, 'error');
            }
        });

        document.getElementById('forgotPassword').addEventListener('click', async (e) => {
            e.preventDefault();
            const emailInput = document.querySelector('input[name="email"]');
            const email = emailInput.value;

            if (!email) {
                showAlert('Please enter your email address first', 'error');
                emailInput.focus();
                return;
            }

            try {
                await sendPasswordResetEmail(auth, email);
                showAlert('Password reset email sent! Please check your inbox.', 'success');
            } catch (error) {
                let errorMessage = 'Failed to send password reset email.';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No account found with this email address.';
                }
                showAlert(errorMessage, 'error');
            }
        });
        
        // Check if we're already logged in
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('User already logged in:', user.email);
                // If the user is already logged in, redirect to dashboard
                window.location.href = 'dashboard.html';
            }
        });
    </script>
</body>

</html>