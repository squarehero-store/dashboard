<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SquareHero Licensing Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        h1, h2 {
            color: #333;
        }
        
        .test-container {
            margin-bottom: 40px;
        }
        
        .plugin-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .plugin-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .plugin-title {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
        }
        
        .plugin-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-inactive {
            background-color: #9e9e9e;
            color: white;
        }
        
        .status-trial {
            background-color: #f9a825;
            color: white;
        }
        
        .status-authorized {
            background-color: #4caf50;
            color: white;
        }
        
        .status-unauthorized {
            background-color: #f44336;
            color: white;
        }
        
        .plugin-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #2196f3;
            color: white;
            font-weight: bold;
        }
        
        button:hover {
            background-color: #1976d2;
        }
        
        button:disabled {
            background-color: #bbdefb;
            cursor: not-allowed;
        }
        
        .license-key-input {
            display: flex;
            margin-top: 15px;
            gap: 10px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .results-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 4px;
            pre {
                white-space: pre-wrap;
                word-break: break-word;
            }
        }
        
        .section-divider {
            border-top: 1px solid #eee;
            margin: 30px 0;
        }
        
        .info-message {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>SquareHero Licensing System Test</h1>
    
    <div class="info-message">
        <p>This page demonstrates the SquareHero Licensing System using localStorage for persistent storage.</p>
        <p>When implemented on Squarespace, it will use local JSON files as the primary data store with Firebase as backup.</p>
    </div>
    
    <div class="test-container">
        <h2>Test Plugins</h2>
        
        <!-- Scroll To Top Plugin -->
        <div class="plugin-card" id="scroll-to-top-card">
            <div class="plugin-header">
                <h3 class="plugin-title">Scroll To Top</h3>
                <span class="plugin-status status-inactive">Loading...</span>
            </div>
            <p>A button that appears when scrolling down the page, allowing visitors to quickly return to the top.</p>
            <div class="plugin-details">
                <div id="scroll-to-top-details">Loading plugin details...</div>
            </div>
            <div class="plugin-actions">
                <button id="scroll-to-top-trial">Start Trial</button>
                <button id="scroll-to-top-validate">Validate License</button>
            </div>
            <div class="license-key-input">
                <input type="text" id="scroll-to-top-license" placeholder="Enter license key (use TEST-LICENSE-KEY for demo)">
                <button id="scroll-to-top-activate">Activate</button>
            </div>
        </div>
        
        <!-- Real Estate Listings Plugin -->
        <div class="plugin-card" id="real-estate-listings-card">
            <div class="plugin-header">
                <h3 class="plugin-title">Real Estate Listings</h3>
                <span class="plugin-status status-inactive">Loading...</span>
            </div>
            <p>Display and manage property listings with search, filtering, and detailed property pages.</p>
            <div class="plugin-details">
                <div id="real-estate-listings-details">Loading plugin details...</div>
            </div>
            <div class="plugin-actions">
                <button id="real-estate-listings-trial">Start Trial</button>
                <button id="real-estate-listings-validate">Validate License</button>
            </div>
            <div class="license-key-input">
                <input type="text" id="real-estate-listings-license" placeholder="Enter license key (use TEST-LICENSE-KEY for demo)">
                <button id="real-estate-listings-activate">Activate</button>
            </div>
        </div>
        
        <!-- Food Menu Plugin -->
        <div class="plugin-card" id="food-menu-card">
            <div class="plugin-header">
                <h3 class="plugin-title">Food Menu</h3>
                <span class="plugin-status status-inactive">Loading...</span>
            </div>
            <p>Create and manage restaurant menus with categories, items, prices, and descriptions.</p>
            <div class="plugin-details">
                <div id="food-menu-details">Loading plugin details...</div>
            </div>
            <div class="plugin-actions">
                <button id="food-menu-trial">Start Trial</button>
                <button id="food-menu-validate">Validate License</button>
            </div>
            <div class="license-key-input">
                <input type="text" id="food-menu-license" placeholder="Enter license key (use TEST-LICENSE-KEY for demo)">
                <button id="food-menu-activate">Activate</button>
            </div>
        </div>
    </div>
    
    <div class="section-divider"></div>
    
    <div class="test-container">
        <h2>System Tests</h2>
        <p>Run full test sequence with pre-defined steps for a specified plugin.</p>
        
        <div class="plugin-actions">
            <button id="run-full-test">Run Full Test Sequence</button>
            <button id="clear-storage">Clear Local Storage</button>
        </div>
        
        <div class="results-container">
            <h3>Test Results</h3>
            <pre id="test-results">Results will appear here...</pre>
        </div>
    </div>

    <!-- Include the SquareHero Licensing System -->
    <script src="licensing.js"></script>
    
    <script>
        // Wait for the licensing system to be loaded and initialized
        document.addEventListener('DOMContentLoaded', async function() {
            // Make sure licensing system is fully initialized
            if (!window.SquareHeroLicensing) {
                console.error("SquareHero Licensing System not found!");
                displayError("Licensing system failed to load. Check console for details.");
                return;
            }
            
            await window.SquareHeroLicensing.initialize({
                debug: true
            });
            
            // Initialize test plugins
            await initializePlugin('scroll-to-top');
            await initializePlugin('real-estate-listings');
            await initializePlugin('food-menu');
            
            // Set up test buttons
            document.getElementById('run-full-test').addEventListener('click', runFullTest);
            document.getElementById('clear-storage').addEventListener('click', clearStorage);
        });
        
        /**
         * Initialize a plugin's UI and connect event handlers
         */
        async function initializePlugin(pluginId) {
            try {
                // Get plugin data
                const data = await window.SquareHeroLicensing.getPluginData(pluginId);
                
                // Check if data exists
                if (!data) {
                    console.error(`No data returned for plugin ${pluginId}`);
                    // Create default data
                    const defaultData = {
                        plugin_id: pluginId,
                        status: 'inactive',
                        created_at: new Date().toISOString(),
                        last_updated: new Date().toISOString()
                    };
                    await window.SquareHeroLicensing.savePluginData(pluginId, defaultData);
                    updatePluginUI(pluginId, defaultData);
                } else {
                    // Update UI with existing data
                    updatePluginUI(pluginId, data);
                }
                
                // Set up event handlers
                document.getElementById(`${pluginId}-trial`).addEventListener('click', () => startTrial(pluginId));
                document.getElementById(`${pluginId}-validate`).addEventListener('click', () => validateLicense(pluginId));
                document.getElementById(`${pluginId}-activate`).addEventListener('click', () => activateWithLicense(pluginId));
            } catch (error) {
                console.error(`Error initializing plugin ${pluginId}:`, error);
                const detailsElement = document.getElementById(`${pluginId}-details`);
                if (detailsElement) {
                    detailsElement.innerHTML = `<span style="color: red;">Error: ${error.message}</span>`;
                }
            }
        }
        
        /**
         * Update a plugin's UI based on its data
         */
        function updatePluginUI(pluginId, data) {
            // Ensure data exists
            if (!data) {
                console.error(`No data provided for updatePluginUI for plugin ${pluginId}`);
                return;
            }
            
            // Update status badge
            const statusElement = document.querySelector(`#${pluginId}-card .plugin-status`);
            if (statusElement) {
                const status = data.status || 'inactive';
                statusElement.className = `plugin-status status-${status}`;
                statusElement.textContent = status.toUpperCase();
            }
            
            // Update details
            const detailsElement = document.getElementById(`${pluginId}-details`);
            if (detailsElement) {
                let details = `<strong>Status:</strong> ${data.status || 'inactive'}<br>`;
                
                if (data.created_at) {
                    details += `<strong>Created:</strong> ${new Date(data.created_at).toLocaleString()}<br>`;
                }
                
                if (data.last_updated) {
                    details += `<strong>Last Updated:</strong> ${new Date(data.last_updated).toLocaleString()}<br>`;
                }
                
                if (data.status === 'trial') {
                    if (data.trial_start) {
                        details += `<strong>Trial Started:</strong> ${new Date(data.trial_start).toLocaleString()}<br>`;
                    }
                    
                    if (data.trial_end) {
                        details += `<strong>Trial Ends:</strong> ${new Date(data.trial_end).toLocaleString()}<br>`;
                        
                        // Calculate days remaining
                        const trialEnd = new Date(data.trial_end);
                        const now = new Date();
                        const daysRemaining = Math.max(0, Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24)));
                        
                        details += `<strong>Days Remaining:</strong> ${daysRemaining}<br>`;
                    }
                }
                
                if (data.status === 'authorized' && data.license_key) {
                    details += `<strong>License Key:</strong> ${data.license_key}<br>`;
                    
                    if (data.activated_at) {
                        details += `<strong>Activated:</strong> ${new Date(data.activated_at).toLocaleString()}<br>`;
                    }
                }
                
                detailsElement.innerHTML = details;
            }
            
            // Update button states
            const trialButton = document.getElementById(`${pluginId}-trial`);
            if (trialButton) {
                trialButton.disabled = data.status === 'authorized' || data.trial_expired;
            }
        }
        
        /**
         * Start a trial for a plugin
         */
        async function startTrial(pluginId) {
            try {
                const result = await window.SquareHeroLicensing.startTrial(pluginId);
                
                if (result.success) {
                    // Update UI
                    const data = await window.SquareHeroLicensing.getPluginData(pluginId);
                    updatePluginUI(pluginId, data);
                    
                    // Display success in test results
                    appendTestResult(`✅ Started trial for ${pluginId}: ${result.message}`);
                } else {
                    appendTestResult(`❌ Failed to start trial for ${pluginId}: ${result.message}`);
                }
            } catch (error) {
                console.error(`Error starting trial for ${pluginId}:`, error);
                appendTestResult(`❌ Error starting trial for ${pluginId}: ${error.message}`);
            }
        }
        
        /**
         * Validate a plugin's license
         */
        async function validateLicense(pluginId) {
            try {
                const result = await window.SquareHeroLicensing.validateLicense(pluginId);
                
                // Display validation result
                appendTestResult(`📋 License validation for ${pluginId}: ${result.message}`);
                
                // Update UI
                const data = await window.SquareHeroLicensing.getPluginData(pluginId);
                updatePluginUI(pluginId, data);
            } catch (error) {
                console.error(`Error validating license for ${pluginId}:`, error);
                appendTestResult(`❌ Error validating license for ${pluginId}: ${error.message}`);
            }
        }
        
        /**
         * Activate a plugin with a license key
         */
        async function activateWithLicense(pluginId) {
            try {
                const licenseKey = document.getElementById(`${pluginId}-license`).value;
                
                if (!licenseKey) {
                    appendTestResult(`❌ No license key provided for ${pluginId}`);
                    return;
                }
                
                const result = await window.SquareHeroLicensing.activateWithLicense(pluginId, licenseKey);
                
                if (result.success) {
                    // Update UI
                    const data = await window.SquareHeroLicensing.getPluginData(pluginId);
                    updatePluginUI(pluginId, data);
                    
                    // Display success in test results
                    appendTestResult(`✅ Activated ${pluginId} with license key: ${result.message}`);
                } else {
                    appendTestResult(`❌ Failed to activate ${pluginId}: ${result.message}`);
                }
            } catch (error) {
                console.error(`Error activating license for ${pluginId}:`, error);
                appendTestResult(`❌ Error activating license for ${pluginId}: ${error.message}`);
            }
        }
        
        /**
         * Run a full test sequence for a plugin
         */
        async function runFullTest() {
            try {
                document.getElementById('test-results').textContent = 'Running full test sequence...\n';
                
                // Choose a random plugin ID for the test
                const plugins = ['scroll-to-top', 'real-estate-listings', 'food-menu'];
                const pluginId = plugins[Math.floor(Math.random() * plugins.length)];
                
                appendTestResult(`🧪 Starting full test sequence for plugin: ${pluginId}`);
                
                // Step 1: Get initial plugin data
                appendTestResult(`\n📋 Step 1: Get initial plugin data`);
                const initialData = await window.SquareHeroLicensing.getPluginData(pluginId);
                appendTestResult(JSON.stringify(initialData, null, 2));
                
                // Step 2: Start trial
                appendTestResult(`\n📋 Step 2: Start trial`);
                const trialResult = await window.SquareHeroLicensing.startTrial(pluginId);
                appendTestResult(JSON.stringify(trialResult, null, 2));
                
                // Step 3: Check trial status
                appendTestResult(`\n📋 Step 3: Check trial status`);
                const trialStatus = await window.SquareHeroLicensing.checkTrialStatus(pluginId);
                appendTestResult(JSON.stringify(trialStatus, null, 2));
                
                // Step 4: Activate with license
                appendTestResult(`\n📋 Step 4: Activate with license`);
                const activationResult = await window.SquareHeroLicensing.activateWithLicense(pluginId, 'TEST-LICENSE-KEY');
                appendTestResult(JSON.stringify(activationResult, null, 2));
                
                // Step 5: Validate license
                appendTestResult(`\n📋 Step 5: Validate license`);
                const validationResult = await window.SquareHeroLicensing.validateLicense(pluginId);
                appendTestResult(JSON.stringify(validationResult, null, 2));
                
                // Step 6: Get final plugin data
                appendTestResult(`\n📋 Step 6: Get final plugin data`);
                const finalData = await window.SquareHeroLicensing.getPluginData(pluginId);
                appendTestResult(JSON.stringify(finalData, null, 2));
                
                // Test completed
                appendTestResult(`\n✅ Test sequence completed successfully!`);
                
                // Update UI
                updatePluginUI(pluginId, finalData);
            } catch (error) {
                console.error(`Error running full test:`, error);
                appendTestResult(`\n❌ Error running full test: ${error.message}`);
            }
        }
        
        /**
         * Clear local storage and reset all plugins
         */
        function clearStorage() {
            try {
                // Clear relevant localStorage items
                const plugins = ['scroll-to-top', 'real-estate-listings', 'food-menu'];
                plugins.forEach(pluginId => {
                    localStorage.removeItem(`squarehero_plugin_${pluginId}`);
                });
                
                appendTestResult('🧹 Cleared local storage for all plugins. Reloading page...');
                
                // Reload the page after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } catch (error) {
                console.error(`Error clearing storage:`, error);
                appendTestResult(`❌ Error clearing storage: ${error.message}`);
            }
        }
        
        /**
         * Append a message to the test results
         */
        function appendTestResult(message) {
            const resultsElement = document.getElementById('test-results');
            resultsElement.textContent += message + '\n';
            
            // Scroll to bottom
            resultsElement.scrollTop = resultsElement.scrollHeight;
        }
        
        /**
         * Display an error message
         */
        function displayError(message) {
            document.body.innerHTML = `
                <div style="padding: 20px; color: red; text-align: center;">
                    <h1>Error</h1>
                    <p>${message}</p>
                </div>
            `;
        }
    </script>
</body>
</html>