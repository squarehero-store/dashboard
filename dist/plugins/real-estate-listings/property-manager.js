!function(){console.log("âœ“ PROPERTY MANAGER SCRIPT LOADED");const e={initialized:!1,initialize:function(e){console.log("Initializing property manager in container:",e);const t=document.getElementById(e);if(t){if(this.initialized&&"true"===t.getAttribute("data-initialized"))return console.log("Property manager already initialized, skipping initialization"),void(this.propertyDataManager&&this.propertyDataManager.renderProperties());t.innerHTML="",this.createPropertyManagerUI(t),this.loadStyles(),this.initPropertyDataManager(t),this.initialized=!0,t.setAttribute("data-initialized","true")}else console.error(`Container element with ID ${e} not found!`)},updateView:function(){console.log("Updating property manager view"),this.propertyDataManager&&this.propertyDataManager.renderProperties()},createPropertyManagerUI:function(e){e.innerHTML='\n                <div class="property-management-container">\n                    <div class="property-toolbar">\n                        <div class="property-toolbar-left">\n                            <div class="view-toggles">\n                                <button type="button" class="button view-toggle active" data-view="grid">\n                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">\n                                        <path d="M0 0h7v7H0V0zm9 0h7v7H9V0zM0 9h7v7H0V9zm9 0h7v7H9V9z"/>\n                                    </svg>\n                                    Grid\n                                </button>\n                                <button type="button" class="button view-toggle" data-view="list">\n                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">\n                                        <path d="M0 1h16v2H0V1zm0 6h16v2H0V7zm0 6h16v2H0v-2z"/>\n                                    </svg>\n                                    List\n                                </button>\n                            </div>\n                        </div>\n                        <div class="property-toolbar-right">\n                            <div class="search-filter">\n                                <input type="text" placeholder="Search properties..." class="property-search">\n                                <select class="property-filter">\n                                    <option value="all">All Properties</option>\n                                    <option value="Ready to Buy">Ready to Buy</option>\n                                    <option value="Under Construction">Under Construction</option>\n                                </select>\n                            </div>\n                        </div>\n                    </div>\n                    \n                    <div id="properties-container" class="properties-grid">\n                        <div class="loading-properties">\n                            <p>Loading properties...</p>\n                        </div>\n                    </div>\n                    \n                    <div class="property-editor-panel" style="display: none;">\n                        <div class="editor-header">\n                            <h3>Edit Property</h3>\n                            <button type="button" class="close-editor">&times;</button>\n                        </div>\n                        <div class="editor-content">\n                            <form id="property-edit-form">\n                                \x3c!-- Form will be dynamically populated --\x3e\n                            </form>\n                        </div>\n                    </div>\n                </div>\n            '},loadStyles:function(){if(document.querySelector('link[href="plugins/real-estate-listings/property-manager.css"]'))return;console.log("Loading property manager CSS");const e=document.createElement("link");e.rel="stylesheet",e.href="plugins/real-estate-listings/property-manager.css",document.head.appendChild(e)},markUnsavedChanges:function(){window.Dashboard&&"function"==typeof window.Dashboard.markUnsavedChanges?(console.log("Marking unsaved changes via Dashboard API"),window.Dashboard.markUnsavedChanges(!0)):window.SettingsPanel&&"function"==typeof window.SettingsPanel.updateNotificationState?(console.log("Using SettingsPanel for unsaved changes notification"),window.SettingsPanel.hasUnsavedChanges=!0,window.SettingsPanel.updateNotificationState()):console.error("No suitable notification system available")},initPropertyDataManager:function(e){const t=this;this.propertyDataManager={elements:{container:e.querySelector("#properties-container"),toolbar:e.querySelector(".property-toolbar"),searchInput:e.querySelector(".property-search"),filterSelect:e.querySelector(".property-filter"),viewToggles:e.querySelectorAll(".view-toggle"),editorPanel:e.querySelector(".property-editor-panel"),editForm:e.querySelector("#property-edit-form"),closeEditor:e.querySelector(".close-editor")},properties:[],propertyDetails:{},filteredProperties:[],currentView:"grid",currentProperty:null,dataLoaded:!1,lastLoadTime:0,cacheLifetime:3e5,markUnsavedChanges:function(){t.markUnsavedChanges()},init:async function(){try{console.log("Initializing property data manager"),await this.loadProperties(),this.bindEventHandlers(),this.renderProperties(),console.log("Property data manager initialized successfully")}catch(e){console.error("Error initializing property data manager:",e)}},loadProperties:async function(){let e=null;try{const t=Date.now(),r=this.dataLoaded&&t-this.lastLoadTime<this.cacheLifetime;if(console.log("Cache status:",{dataLoaded:this.dataLoaded,timeSinceLastLoad:this.dataLoaded?((t-this.lastLoadTime)/1e3).toFixed(1)+"s":"n/a",cacheLifetime:this.cacheLifetime/1e3+"s",cacheValid:r}),r)return console.log("Using cached property data, last loaded:",new Date(this.lastLoadTime).toLocaleTimeString()),this.renderProperties(),this.properties;this.dataLoaded||(window.SkeletonLoader?(console.log("Using skeleton loader for properties"),e=window.SkeletonLoader.show("properties-container","propertyCard",6)):(console.log("Skeleton loader not available, using simple loading UI"),this.elements.container.innerHTML='<div class="loading-properties"><p>Loading properties...</p></div>'));const i="https://cdn.jsdelivr.net/gh/squarehero-store/dashboard@0/plugins/real-estate-listings/properties-data.json",o=await fetch(i);if(!o.ok)throw new Error(`Failed to load properties JSON. Status: ${o.status}`);const a=await o.json();if(!a||!a.items||!Array.isArray(a.items))throw new Error("Invalid property data structure");this.properties=a.items;let n={};if(window.Dashboard&&window.Dashboard.FirebaseService)try{const e=await window.Dashboard.FirebaseService.getPluginSettings("real-estate-listings");e&&e.propertyDetails&&"object"==typeof e.propertyDetails&&(console.log("Loaded property details from Firebase:",Object.keys(e.propertyDetails).length,"properties"),n=e.propertyDetails)}catch(e){console.warn("Error loading property details from Firebase:",e)}return this.propertyDetails=n,this.filteredProperties=[...this.properties],this.dataLoaded=!0,this.lastLoadTime=Date.now(),e&&e.hide(),this.properties}catch(t){return console.error("Error loading properties:",t),e&&e.hide(),this.properties=[],this.filteredProperties=[],this.dataLoaded=!1,this.elements.container&&(this.elements.container.innerHTML=`\n                                <div class="error-message">\n                                    <p>Error loading properties: ${t.message}</p>\n                                </div>\n                            `),[]}},forceReload:function(){this.dataLoaded=!1,this.lastLoadTime=0,this.loadProperties().then((()=>{this.renderProperties()}))},bindEventHandlers:function(){this.elements.viewToggles.forEach((e=>{e.addEventListener("click",(e=>{this.elements.viewToggles.forEach((e=>e.classList.remove("active"))),e.currentTarget.classList.add("active"),this.currentView=e.currentTarget.getAttribute("data-view"),this.renderProperties()}))})),this.elements.searchInput.addEventListener("input",(e=>{this.searchProperties(e.target.value)})),this.elements.filterSelect.addEventListener("change",(e=>{this.filterProperties(e.target.value)})),this.elements.closeEditor&&this.elements.closeEditor.addEventListener("click",(()=>{this.closeEditor()}))},searchProperties:function(e){if(e){const t=e.toLowerCase();this.filteredProperties=this.properties.filter((e=>e.title.toLowerCase().includes(t)||e.tags&&e.tags.some((e=>e.toLowerCase().includes(t)))))}else this.filteredProperties=[...this.properties];this.renderProperties()},filterProperties:function(e){this.filteredProperties="all"===e?[...this.properties]:this.properties.filter((t=>t.categories&&t.categories.includes(e))),this.renderProperties()},getPropertyDetails:function(e){const t=e.id,r=this.propertyDetails[t]||{};let i=r.bedrooms,o=r.bathrooms,a=r.area,n=r.year,s=r.price;if(i||(i=this.extractValueFromContent(e.body,"Bedrooms")),o||(o=this.extractValueFromContent(e.body,"Bathrooms")),a||(a=this.extractValueFromContent(e.body,"Area")),n||(n=this.extractValueFromContent(e.body,"Year Built")),!s&&e.excerpt){const t=e.excerpt.match(/\$([0-9,]+)/);t&&t[1]&&(s=t[1].replace(/,/g,""))}return{bedrooms:i,bathrooms:o,area:a,year:n,price:s}},renderProperties:function(){const e=this.elements.container;e?(e.innerHTML="",this.filteredProperties&&0!==this.filteredProperties.length?("grid"===this.currentView?(e.className="properties-grid",this.filteredProperties.forEach((t=>{e.appendChild(this.createGridItem(t))}))):(e.className="properties-list",this.filteredProperties.forEach((t=>{e.appendChild(this.createGridItem(t))}))),console.log(`Rendered ${this.filteredProperties.length} properties in ${this.currentView} view`)):e.innerHTML='<div class="no-properties">No properties found matching your criteria.</div>'):console.error("Properties container not found")},createGridItem:function(e){const t=document.createElement("div");t.className="property-grid-item",t.setAttribute("data-id",e.id);const r=e.assetUrl||"https://placehold.co/400x300?text=No+Image",i=e.tags&&e.tags.length>0?e.tags[0]:"",o=e.categories&&e.categories.length>0?e.categories[0]:"",a=this.getPropertyDetails(e);let n="Price TBA";a.price&&(n="$"+parseInt(a.price).toLocaleString());t.innerHTML=`\n                        <div class="property-image">\n                            <img src="${r}" alt="${e.title}">\n                            ${o?`<span class="property-category">${o}</span>`:""}\n                            <div class="property-actions">\n                                <button type="button" class="edit-property" title="Edit Property">Edit</button>\n                            </div>\n                        </div>\n                        <div class="listing-content">\n                            <h3 class="property-title">${e.title}</h3>\n                            <p class="property-location">${i}</p>\n                            <p class="property-price">${n}</p>\n                            <div class="property-details">\n                                ${a.area?`<span class="details-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="17" fill="none" viewBox="0 0 18 17"><g fill="currentColor" clip-path="url(#areaClip)"><path d="M.364 3.203 0 2.839 2.202.638l2.202 2.201-.363.364a.794.794 0 0 1-1.122 0l-.717-.715-.714.715a.794.794 0 0 1-1.124 0Z"/><path d="M16.855 15.016H1.548V1.563h1.308v12.144h14v1.309Z"/><path d="m15.58 16.564-.364-.364a.794.794 0 0 1 0-1.121l.714-.715-.714-.715a.794.794 0 0 1 0-1.122l.363-.363 2.202 2.202-2.202 2.198ZM16.119 11.598h-.634a.654.654 0 0 1 0-1.308h.634c.192 0 .347-.14.347-.317v-.614a.654.654 0 1 1 1.309 0v.614c0 .896-.743 1.625-1.656 1.625ZM13.063 11.599H9.727a.654.654 0 1 1 0-1.309h3.336a.654.654 0 0 1 0 1.309ZM7.251 11.598h-.633c-.913 0-1.657-.729-1.657-1.625v-.614a.654.654 0 1 1 1.309 0v.614c0 .175.156.317.348.317h.633a.654.654 0 1 1 0 1.309ZM5.616 7.727a.654.654 0 0 1-.655-.654V5.17a.654.654 0 1 1 1.309 0v1.904a.654.654 0 0 1-.654.654ZM5.616 3.537a.654.654 0 0 1-.655-.654v-.614c0-.896.744-1.625 1.657-1.625h.633a.654.654 0 0 1 0 1.308h-.633c-.192 0-.348.14-.348.317v.614a.654.654 0 0 1-.654.654ZM13.01 1.952H9.674a.654.654 0 0 1 0-1.308h3.337a.654.654 0 0 1 0 1.308ZM17.12 3.537a.654.654 0 0 1-.654-.654v-.614c0-.175-.155-.317-.347-.317h-.634a.654.654 0 1 1 0-1.308h.634c.913 0 1.656.729 1.656 1.625v.614a.654.654 0 0 1-.654.654ZM17.12 7.727a.655.655 0 0 1-.654-.654V5.17a.654.654 0 1 1 1.309 0v1.904a.654.654 0 0 1-.654.654Z"/></g><defs><clipPath id="areaClip"><path fill="#fff" d="M0 .65h17.759v15.89H0z"/></clipPath></defs></svg> <span>${a.area} sq ft</span></span>`:""}\n                                ${a.bedrooms?`<span class="details-icon"><svg xmlns="http://www.w3.org/2000/svg" width="23" height="21" fill="none" viewBox="0 0 23 21"><g clip-path="url(#bedsClip)"><path fill="currentColor" d="M2.735 4.856a.907.907 0 0 0-.95-.906.923.923 0 0 0-.863.93v12.09h1.814v-3.627h4.532V9.716H2.735v-4.86Zm16.1 1.66H8.174v6.827h12.022V7.875a1.36 1.36 0 0 0-1.36-1.36Zm3.085 3.2h-.819v7.254h1.814v-6.26a.994.994 0 0 0-.995-.994ZM5.573 5.613a1.814 1.814 0 1 0-.237 3.62 1.814 1.814 0 0 0 .237-3.62Z"/></g><defs><clipPath id="bedsClip"><path fill="#fff" d="M.685.65h22.23v19.89H.685z"></path></clipPath></defs></svg> <span>${a.bedrooms}</span></span>`:""}\n                                ${a.bathrooms?`<span class="details-icon"><svg xmlns="http://www.w3.org/2000/svg" width="19" height="17" fill="none" viewBox="0 0 19 17"><g fill="currentColor" clip-path="url(#bathsClip)"><path d="M13.361 6.618a.389.389 0 1 0 0 .778.389.389 0 0 0 0-.778Zm-1.553-1.166a.388.388 0 1 0 .147.028.389.389 0 0 0-.15-.029l.003.001Zm-.196 1.166a.389.389 0 1 0 0 .778.389.389 0 0 0 0-.778Zm1.749-1.166a.389.389 0 1 0-.001.78.389.389 0 0 0 .001-.78Zm2.137-1.165H11.03a.389.389 0 1 0 0 .777h4.468a.39.39 0 1 0 0-.777ZM15.304.594a2.717 2.717 0 0 0-2.249 1.19 2.135 2.135 0 0 0-1.831 2.113h4.274a2.136 2.136 0 0 0-1.537-2.05 1.981 1.981 0 0 1 1.343-.524c.95 0 1.942.686 1.942 1.991v4.471h.778v-4.47a2.72 2.72 0 0 0-2.72-2.72Zm.194 6.412a.388.388 0 1 0-.777-.001.388.388 0 0 0 .777 0Zm-.194-1.166a.39.39 0 0 0-.664-.275.389.389 0 1 0 .664.275ZM1.537 11.722a3.477 3.477 0 0 0 1.75 3.018l-.889.889a.566.566 0 1 0 .8.8l1.274-1.273c.18.03.363.045.545.046h9.53c.182 0 .364-.017.545-.046l1.273 1.273a.565.565 0 1 0 .8-.8l-.889-.89a3.478 3.478 0 0 0 1.752-3.017v-1.393H1.537v1.393Zm.696-3.133h-.696a.696.696 0 0 0-.696.696v.348h17.882v-.348a.696.696 0 0 0-.696-.696H2.233Z"/></g><defs><clipPath id="bathsClip"><path fill="#fff" d="M.84.594h17.883v16H.84z"></path></clipPath></defs></svg> <span>${a.bathrooms}</span></span>`:""}\n                                ${a.year?`<span class="details-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg> <span>${a.year}</span></span>`:""}\n                            </div>\n                        </div>\n                    `;return t.querySelector(".edit-property").addEventListener("click",(t=>{t.stopPropagation(),this.openEditor(e)})),t.addEventListener("click",(()=>{this.openEditor(e)})),t},extractValueFromContent:function(e,t){if(!e)return"";const r=new RegExp(`${t}\\s*:\\s*([\\d.]+)`,"i"),i=e.match(r);return i&&i[1]?i[1].trim():""},openEditor:function(e){console.log("Opening editor for property:",e.title),this.currentProperty=e;const t=this.elements.editForm;t.innerHTML="";const r=this.getPropertyDetails(e);t.innerHTML=`\n                        <div class="form-group form-group-full">\n                            <label for="property-title">Property Title</label>\n                            <input type="text" id="property-title" value="${e.title||""}" class="setting-input" readonly>\n                            <p class="setting-help">Property title from Squarespace (read-only)</p>\n                        </div>\n                        \n                        <div class="form-group form-group-half">\n                            <label for="property-status">Status</label>\n                            <select id="property-status" class="setting-input" disabled>\n                                <option value="Ready to Buy" ${e.categories&&e.categories.includes("Ready to Buy")?"selected":""}>Ready to Buy</option>\n                                <option value="Under Construction" ${e.categories&&e.categories.includes("Under Construction")?"selected":""}>Under Construction</option>\n                                <option value="Sold" ${e.categories&&e.categories.includes("Sold")?"selected":""}>Sold</option>\n                            </select>\n                            <p class="setting-help">Status from Squarespace categories (read-only)</p>\n                        </div>\n                        \n                        <div class="form-group form-group-half">\n                            <label for="property-location">Location</label>\n                            <select id="property-location" class="setting-input" disabled>\n                                <option value="Raleigh, NC" ${e.tags&&e.tags.includes("Raleigh, NC")?"selected":""}>Raleigh, NC</option>\n                                <option value="Wilmington, NC" ${e.tags&&e.tags.includes("Wilmington, NC")?"selected":""}>Wilmington, NC</option>\n                                <option value="Asheville, NC" ${e.tags&&e.tags.includes("Asheville, NC")?"selected":""}>Asheville, NC</option>\n                                <option value="Charlotte, NC" ${e.tags&&e.tags.includes("Charlotte, NC")?"selected":""}>Charlotte, NC</option>\n                            </select>\n                            <p class="setting-help">Location from Squarespace tags (read-only)</p>\n                        </div>\n                        \n                        <div class="form-group form-group-half">\n                            <label for="property-price">Price ($)</label>\n                            <input type="number" id="property-price" value="${r.price||""}" class="setting-input" min="0" step="1000">\n                        </div>\n                        \n                        <h3 class="settings-section-title">Property Details</h3>\n                        \n                        <div class="form-group form-group-quarter">\n                            <label for="property-bedrooms">Bedrooms</label>\n                            <div class="slider-container">\n                                <input type="range" id="property-bedrooms" value="${r.bedrooms||0}" min="0" max="10" step="1" class="slider-input">\n                                <span class="slider-value">${r.bedrooms||0}</span>\n                            </div>\n                        </div>\n                        \n                        <div class="form-group form-group-quarter">\n                            <label for="property-bathrooms">Bathrooms</label>\n                            <div class="slider-container">\n                                <input type="range" id="property-bathrooms" value="${r.bathrooms||0}" min="0" max="10" step="0.5" class="slider-input">\n                                <span class="slider-value">${r.bathrooms||0}</span>\n                            </div>\n                        </div>\n                        \n                        <div class="form-group form-group-quarter">\n                            <label for="property-area">Area (sq ft)</label>\n                            <input type="number" id="property-area" value="${r.area||""}" class="setting-input" min="0" step="100">\n                        </div>\n                        \n                        <div class="form-group form-group-quarter">\n                            <label for="property-year">Year Built</label>\n                            <input type="number" id="property-year" value="${r.year||""}" class="setting-input" min="1900" max="2100">\n                        </div>\n                    `,this.bindEditorEvents(t),this.elements.editorPanel.style.display="block",this.elements.container.style.display="none",this.elements.toolbar.style.display="none"},bindEditorEvents:function(e){e.querySelectorAll("input:not([readonly]), select:not([disabled]), textarea").forEach((e=>{const t="range"===e.type?"input":"change";e.addEventListener(t,(()=>{if("range"===e.type){const t=e.nextElementSibling;t&&t.classList.contains("slider-value")&&(t.textContent=e.value)}this.markUnsavedChanges()}))}))},closeEditor:function(){this.elements.editorPanel&&(this.elements.editorPanel.style.display="none"),this.elements.container&&(this.elements.container.style.display="grid"===this.currentView?"grid":"block"),this.elements.toolbar&&(this.elements.toolbar.style.display="flex"),this.currentProperty=null},applyChanges:function(){if(!this.currentProperty)return!1;const e=this.currentProperty.id,t=this.elements.editForm,r=t.querySelector("#property-price"),i=t.querySelector("#property-bedrooms"),o=t.querySelector("#property-bathrooms"),a=t.querySelector("#property-area"),n=t.querySelector("#property-year");return this.propertyDetails[e]||(this.propertyDetails[e]={}),this.propertyDetails[e].title=this.currentProperty.title,r.value&&(this.propertyDetails[e].price=r.value),i.value&&"0"!==i.value&&(this.propertyDetails[e].bedrooms=i.value),o.value&&"0"!==o.value&&(this.propertyDetails[e].bathrooms=o.value),a.value&&(this.propertyDetails[e].area=a.value),n.value&&(this.propertyDetails[e].year=n.value),this.closeEditor(),this.renderProperties(),this.savePropertyDetails(),!0},savePropertyDetails:function(){window.Dashboard&&window.Dashboard.FirebaseService?window.Dashboard.FirebaseService.getPluginSettings("real-estate-listings").then((e=>{const t={...e,propertyDetails:this.propertyDetails};window.Dashboard.FirebaseService.updatePluginSettings("real-estate-listings",t).then((e=>{e?console.log("Property details saved to Firebase successfully"):console.error("Failed to save property details to Firebase")}))})).catch((e=>{console.error("Error getting current settings:",e)})):console.warn("Firebase service not available, property details stored in memory only")},registerProperties:function(){window.Dashboard&&window.Dashboard.CustomComponentDataRegistry&&(window.Dashboard.CustomComponentDataRegistry.register("real-estate-listings","property-manager",this.propertyDetails),console.log("Registered property data with dashboard registry"))}},this.propertyDataManager.init()},onSaveHandler:function(e){return console.log("Property Manager onSaveHandler called"),!this.propertyDataManager||!this.propertyDataManager.currentProperty||this.propertyDataManager.applyChanges()},getPropertyDetails:function(){return this.propertyDataManager&&this.propertyDataManager.propertyDetails?this.propertyDataManager.propertyDetails:{}}};window.PropertyManager=e,void 0!==window.Dashboard&&(console.log("Registering property manager with Dashboard"),window.Dashboard.PluginRegistry&&"function"==typeof window.Dashboard.PluginRegistry.register&&window.Dashboard.PluginRegistry.register("real-estate-listings","settings",e)),window.initPropertyManager=function(){console.log("Manual initialization requested");const t=document.getElementById("property-manager-container")||document.querySelector('.custom-component-container[data-component-id="property-manager"]');return t?(console.log("Container found:",t.id),e.initialize(t.id),!0):(console.error("Container not found during manual initialization"),!1)},window.updatePropertyManager=function(){return console.log("Update property manager view requested"),!!e.updateView&&(e.updateView(),!0)},window["property-managerValues"]={getDetails:function(){return e.propertyDataManager&&e.propertyDataManager.propertyDetails?e.propertyDataManager.propertyDetails:{}}},document.addEventListener("DOMContentLoaded",(function(){const t=document.getElementById("property-manager-container")||document.querySelector('.custom-component-container[data-component-id="property-manager"]');t&&(console.log("Auto-initializing PropertyManager on DOM content loaded"),e.initialize(t.id))}))}();